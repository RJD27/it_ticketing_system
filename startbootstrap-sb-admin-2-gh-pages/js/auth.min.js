/*!
 * Start Bootstrap - SB Admin 2 v4.1.3 (https://startbootstrap.com/theme/sb-admin-2)
 * Copyright 2013-2023 Start Bootstrap
 * Licensed under MIT (https://github.com/StartBootstrap/startbootstrap-sb-admin-2/blob/master/LICENSE)
 */

require("dotenv").config();const session=require("express-session"),localStrategy=require("passport-local"),passport=require("passport"),mysql=require("mysql2"),bodyParser=require("body-parser"),bcrypt=require("bcrypt"),GetUserDatabase=require("./databaseHandler")["GetUserDatabase"];module.exports=function(e){e.use(bodyParser.urlencoded({extended:!0})),e.use(bodyParser.json());const n=GetUserDatabase(mysql);console.log("Auth.js kicking in!"),e.use(session({secret:process.env.SESSION_SECRET,resave:!0,saveUninitialized:!0,cookie:{secure:!1}})),e.use(passport.initialize()),e.use(passport.session()),n.connect(e=>{if(e)return console.log(e);console.log("DB connection outside of passport established..."),passport.use(new localStrategy({usernameField:"email",passwordField:"password"},function(s,r,l){console.log("localstrategy user is..."),console.log(s);n.query("SELECT 1 FROM users WHERE Email = ?",[s],function(e,o){return e?console.log(e):o.length<1?(console.log("No account found."),l(null,null)):void n.query("SELECT PasswordHash FROM users WHERE Email = ?",[s],function(e,s){return e?console.log(e):bcrypt.compareSync(r,s[0].PasswordHash)?l(null,o[0]):(console.log("Email or password incorrect."),l(null,null))})})})),passport.serializeUser((e,s)=>{console.log("Serialize user..."),s(null,e)}),passport.deserializeUser((e,o)=>{console.log(e),console.log("Deserialize user..."),n.query("SELECT * FROM Users WHERE UserID = ?",[e[0]],function(e,s){if(e)throw e;return o(null,s)})})})};